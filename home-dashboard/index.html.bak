<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="Author" content="Tamer Barsbay">
        <meta name="Keywords" content="">
        <meta name="Description" content="">

        <!-- Load webcomponents-lite.min.js for polyfill support. -->
        <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
        <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

        <!-- Bootstrap -->
        <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Use an HTML Import to bring in some elements. -->
        <link rel="import" href="bower_components/polymer/polymer.html">
        <link rel="import" href="bower_components/iron-icons/iron-icons.html">
        <link rel="import" href="bower_components/iron-icons/maps-icons.html">
        <link rel="import" href="bower_components/iron-icons/communication-icons.html">
        <link rel="import" href="bower_components/iron-icons/social-icons.html">
        <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
        <link rel="import" href="bower_components/paper-styles/paper-styles.html" />
        <link rel="import" href="bower_components/paper-card/paper-card.html">
        <link rel="import" href="bower_components/paper-fab/paper-fab.html">
        <link rel="import" href="bower_components/paper-progress/paper-progress.html">
        <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
        <link rel="import" href="bower_components/google-signin/google-signin.html">
        <link rel="import" href="bower_components/google-signin/google-signin-aware.html">

        <title>Home Dashboard</title>

        <style is="custom-style">
            body {
                background-color: #E3F2FD;
            }

            .page-header {
                color: #2196F3;
            }

            paper-card {
                width: 100%
                --paper-card-header-color: #2196F3; 
            }

            paper-toolbar {
                --paper-toolbar-background: #1565C0;    
            }

            paper-fab {
                position: fixed;
                bottom: 16px;
                right: 16px;
            }

            paper-progress {
                width: 100%
                --paper-progress-active-color: #2196F3;
            }

            iron-icon.icon-bus {
                --iron-icon-fill-color: #616161;
            }

            iron-icon.icon-message {
                --iron-icon-fill-color: #616161;
            }

            iron-icon.icon-person {
                --iron-icon-fill-color: #616161;
            }

            .route-arrivals-header {
                font-size: 14px;
                background-color: #EEEEEE;
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 4px;
                padding-right: 4px;
            }

            .route-arrivals-times {
                font-size: 20px;
                padding-left: 32px;
                padding-right: 8px;
            }

            .message-senderName {
                font-size: 16px;
                padding-left: 4px;
                padding-right: 4px;
            }

            .message-text {
                opacity: .87;
                font-size: 16px;
                padding-left: 32px;
                padding-right: 4px;
            }

            .message-timestamp {
                color: #9E9E9E;
                font-size: 12px;
                padding-left: 32px;
                padding-right: 8px;
            }
        </style>

        <script>
            var progress;

            String.prototype.format = function()
            {
               var content = this;
               for (var i=0; i < arguments.length; i++)
               {
                    var replacement = '{' + i + '}';
                    content = content.replace(replacement, arguments[i]);  
               }
               return content;
            };

            var routeArrivalsTemplate = "<div><iron-icon class=\"icon-bus\" icon=\"maps:directions-bus\"></iron-icon><span class=\"route-arrivals-header\"><b>{0} - {1}</b></span><br><span class=\"route-arrivals-times\">{2}</span></div>";

            function initialize() {
                loadArrivalTimes();
            }
            
            function refresh() {
                showLoadingViews();
                loadArrivalTimes();
            }

            function showLoadingViews() {
                document.getElementById("arrival-card-content").innerHTML = "<paper-progress indeterminate id=\"arrival-card-progress\"></paper-progress>";
            }

            function loadArrivalTimes() {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        var arrivalsArray = JSON.parse(xmlhttp.responseText);
                        renderArrivals(arrivalsArray);
                    }
                };
                xmlhttp.open("GET", "/arrivals", true);
                xmlhttp.send();
            }

            function renderArrivals(arrivals) {
                var out = "";
                var i;
                for (i = 0; i < arrivals.length; i++) {
                    out += routeArrivalsTemplate.format(arrivals[i].routeName, arrivals[i].stopName, arrivals[i].arrivals) + '<br>';
                }
                document.getElementById("arrival-card-content").innerHTML = out;
            }
            
            window.addEventListener('WebComponentsReady', function() {
              progress = document.querySelector('paper-progress');
            });
        </script>
    </head>
    <body fullbleed unresolved onload="initialize()">

        <paper-toolbar>
            <paper-icon-button icon="menu"></paper-icon-button>
        </paper-toolbar>    

        <div class="container">
            <div class="page-header">
                <h1>Good morning!</h1>
                <br>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <paper-card class="arrival-time" heading="Transit">
                        <div class="card-content" id="arrival-card-content">
                            <paper-progress indeterminate id="arrival-card-progress"></paper-progress>
                        </div>
                    </paper-card>
                </div>
                
                <div class="col-md-6">
                    <paper-card class="weather" heading="Weather">
                        <div class="card-content"></div>
                    </paper-card>
                    <br>
                    <br>
                    <paper-card class="schedule" heading="Schedule">
                        <div class="card-content">
                            <div id="schedule-card-content">
                                
                            </div>
                            <google-signin width="iconOnly" client-id="602698472379-aiulm54afilofccvcantfc4ka46qnlpa.apps.googleusercontent.com" scopes="https://www.googleapis.com/auth/calendar.readonly"></google-signin>
                            <template id="awareness" is="dom-bind">
                                <google-signin-aware
                                    id="aware"
                                    client-id="602698472379-aiulm54afilofccvcantfc4ka46qnlpa.apps.googleusercontent.com"
                                    scopes="https://www.googleapis.com/auth/calendar.readonly"
                                    offline
                                    on-google-signin-aware-success="handleSignIn"
                                    on-google-signin-offline-success="handleOffline"></google-signin-aware>
                            </template>
                            
                            <script>
                                var aware = document.querySelector('#awareness');
                                aware.status = 'Not granted';
                                aware.handleSignIn = function(response) {
                                    this.status = 'Signed in'
                                    var user = gapi.auth2.getAuthInstance().currentUser.get();
                                    console.log('User name: ' + user.getBasicProfile().getName());

                                    loadCalendarApi();
                                };
                                aware.handleOffline = function(response) {
                                    console.log('Offline code received: ' + response.detail.code);
                                    // Here you would POST response.detail.code to your webserver, which can
                                    // exchange the authorization code for an access token. More info at:
                                    // https://developers.google.com/identity/protocols/OAuth2WebServer
                                };
                                aware.handleSignOut = function(response) {
                                    this.status = 'Signed out'
                                    console.log('[Aware] Signout Response', response);
                                };

                                function loadCalendarApi() {
                                    gapi.client.load('calendar', 'v3', loadSchedule);
                                }

                                function loadSchedule() {
                                    var request = gapi.client.calendar.events.list({
                                        'calendarId': 'primary',
                                        'timeMin': '2016-01-27T8:00:00-08:00',
                                        'timeMax': '2016-01-27T23:00:00-08:00', // make automatically select today's date
                                        'showDeleted': 'false',
                                        'singleEvents': 'true',
                                        'orderBy': 'startTime'
                                    });

                                    request.execute(function(resp) {
                                        var events = resp.items;
                                        if (events.length > 1) {
                                            var firstEvent = events[0];
                                            var whenFirstStarts = firstEvent.start.dateTime;
                                            if (!whenFirstStarts) {
                                                whenFirstStarts = firstEvent.start.date;
                                            }
                                            console.log("First event starts at: " + whenFirstStarts);

                                            var lastEvent = events[events.length-1]
                                            var whenLastEnds = lastEvent.end.dateTime;
                                            if (!whenLastEnds) {
                                                whenLastEnds = lastEvent.end.date;
                                            }
                                            console.log("Last event ends at: " + whenLastEnds);
                                        } else if (events.length == 1) {
                                            // Only one event today
                                            var onlyEvent = events[0];
                                            var whenEventStarts = onlyEvent.start.dateTime;
                                            if (!whenFirstStarts) {
                                                whenFirstStarts = onlyEvent.start.date;
                                            }
                                            var whenEventEnds = onlyEvent.end.dateTime;
                                            if (!whenEventEnds) {
                                                whenEventEnds = onlyEvent.end.date;
                                            }
                                            console.log("Only event starts at: " + whenEventStarts);
                                            console.log("Only event ends at: " + whenEventEnds);
                                        }
                                    });
                                }
                            </script>
                        </div>
                    </paper-card>
                </div>
            </div> <!-- /row 1 -->

            <!-- Refresh screen -->
            <paper-fab icon="refresh" onclick="refresh()"></paper-fab>
        </div> <!-- /container -->
    </body>
</html>
